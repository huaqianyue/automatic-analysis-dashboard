<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSALab å­¦ç”Ÿè¡Œä¸ºåˆ†æ Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    
    <style>
        .chart-container {
            width: 100%;
            height: 400px;
        }
        .student-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .problem-card:hover {
            background-color: #f9fafb;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">ğŸ“Š DSALab å­¦ç”Ÿè¡Œä¸ºåˆ†æ</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <input type="file" id="fileInput" accept=".json" class="hidden">
                    <button onclick="document.getElementById('fileInput').click()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition">
                        ğŸ“ åŠ è½½æ•°æ®æ–‡ä»¶
                    </button>
                    <div id="dataInfo" class="text-sm text-gray-600"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- åŠ è½½æç¤º -->
        <div id="loadingScreen" class="text-center py-20">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">è¯·ç‚¹å‡»ä¸Šæ–¹"åŠ è½½æ•°æ®æ–‡ä»¶"æŒ‰é’®ï¼Œé€‰æ‹©ç”Ÿæˆçš„ dashboard.json æ–‡ä»¶</p>
        </div>

        <!-- Dashboard å†…å®¹ -->
        <div id="dashboardContent" class="hidden">
            
            <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
            <section id="overviewSection" class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ“ˆ ç»Ÿè®¡æ¦‚è§ˆ</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- ç»Ÿè®¡å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>

            <!-- è–„å¼±çŸ¥è¯†ç‚¹åˆ†æ -->
            <section id="weakPointsSection" class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">âš ï¸ è–„å¼±çŸ¥è¯†ç‚¹åˆ†å¸ƒ</h2>
                <div class="bg-white rounded-lg shadow p-6">
                    <div id="weakPointsChart" class="chart-container"></div>
                </div>
                
                <!-- è–„å¼±çŸ¥è¯†ç‚¹è¯¦ç»†åˆ—è¡¨ -->
                <div id="weakPointsDetails" class="mt-6 space-y-4">
                    <!-- è¯¦ç»†ä¿¡æ¯å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>

            <!-- é¢˜ç›®ç»Ÿè®¡ -->
            <section id="problemsSection" class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ“ é¢˜ç›®ç»Ÿè®¡</h2>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">é¢˜ç›®ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">æäº¤äººæ•°</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">é€šè¿‡ç‡</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å¹³å‡åˆ†</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å¹³å‡è¿è¡Œæ¬¡æ•°</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å¹³å‡æµ‹è¯•æ¬¡æ•°</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">å¹³å‡ç”¨æ—¶</th>
                            </tr>
                        </thead>
                        <tbody id="problemsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- è¡¨æ ¼å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- å­¦ç”Ÿåˆ—è¡¨ -->
            <section id="studentsSection" class="mb-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ‘¥ å­¦ç”Ÿè¯¦æƒ…</h2>
                
                <!-- æœç´¢å’Œç­›é€‰ -->
                <div class="mb-4 flex space-x-4">
                    <input type="text" id="studentSearch" placeholder="æœç´¢å­¦ç”ŸID..." 
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <select id="problemFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">æ‰€æœ‰é¢˜ç›®</option>
                    </select>
                </div>
                
                <!-- å­¦ç”Ÿå¡ç‰‡ç½‘æ ¼ -->
                <div id="studentsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- å­¦ç”Ÿå¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </section>

        </div>

    </main>

    <!-- å­¦ç”Ÿè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="studentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-lg bg-white">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-900"></h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">Ã—</button>
            </div>
            <div id="modalContent" class="mt-4">
                <!-- è¯¦ç»†å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€æ•°æ®
        let dashboardData = null;
        let currentStudentFilter = '';
        let currentProblemFilter = '';

        // åŠ è½½æ•°æ®æ–‡ä»¶
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        dashboardData = JSON.parse(event.target.result);
                        loadDashboard();
                    } catch (error) {
                        alert('JSONè§£æå¤±è´¥: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        });

        // åŠ è½½Dashboard
        function loadDashboard() {
            if (!dashboardData) return;

            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('dashboardContent').classList.remove('hidden');

            // æ›´æ–°æ•°æ®ä¿¡æ¯
            document.getElementById('dataInfo').textContent = 
                `${dashboardData.assignment_name} | ${dashboardData.generated_time}`;

            // æ¸²æŸ“å„ä¸ªéƒ¨åˆ†
            renderOverview();
            renderWeakPoints();
            renderProblems();
            renderStudents();
        }

        // æ¸²æŸ“ç»Ÿè®¡æ¦‚è§ˆ
        function renderOverview() {
            const stats = dashboardData.statistics_summary;
            const section = document.getElementById('overviewSection');
            const grid = section.querySelector('.grid');

            const cards = [
                { title: 'å­¦ç”Ÿæ€»æ•°', value: stats.total_students, icon: 'ğŸ‘¥', color: 'blue' },
                { title: 'é¢˜ç›®æ€»æ•°', value: stats.total_problems, icon: 'ğŸ“', color: 'green' },
                { title: 'å¹³å‡åˆ†', value: stats.average_score.toFixed(1), icon: 'ğŸ“Š', color: 'yellow' },
                { title: 'é€šè¿‡ç‡', value: stats.pass_rate.toFixed(1) + '%', icon: 'âœ…', color: 'purple' }
            ];

            grid.innerHTML = cards.map(card => `
                <div class="bg-white rounded-lg shadow p-6 border-l-4 border-${card.color}-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-sm">${card.title}</p>
                            <p class="text-3xl font-bold text-gray-900 mt-2">${card.value}</p>
                        </div>
                        <div class="text-4xl">${card.icon}</div>
                    </div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“è–„å¼±çŸ¥è¯†ç‚¹ï¼ˆæŒ‰é¢˜ç›®åˆ†ç»„ï¼‰
        function renderWeakPoints() {
            const weakPointsByProblem = dashboardData.weak_points_by_problem;
            
            if (!weakPointsByProblem || Object.keys(weakPointsByProblem).length === 0) {
                document.getElementById('weakPointsSection').innerHTML = 
                    '<p class="text-gray-600">æš‚æ— è–„å¼±çŸ¥è¯†ç‚¹æ•°æ®</p>';
                return;
            }

            // æ”¶é›†æ‰€æœ‰åˆ†ç±»ç”¨äºå›¾è¡¨
            let allCategories = [];
            for (const [problemId, problemData] of Object.entries(weakPointsByProblem)) {
                if (problemData.classified_categories) {
                    problemData.classified_categories.forEach(cat => {
                        allCategories.push({
                            problemId: problemId,
                            name: cat.name,
                            value: cat.student_count,
                            severity: cat.severity,
                            avg_score: cat.avg_score
                        });
                    });
                }
            }

            // æ¸²æŸ“æ¦‚è§ˆé¥¼å›¾ï¼ˆå±•ç¤ºå„é¢˜ç›®è–„å¼±ç‚¹åˆ†å¸ƒï¼‰
            if (allCategories.length > 0) {
                const chart = echarts.init(document.getElementById('weakPointsChart'));
                const option = {
                    title: {
                        text: 'è–„å¼±çŸ¥è¯†ç‚¹åˆ†ç±»ç»Ÿè®¡',
                        subtext: 'æŒ‰é¢˜ç›®å’Œåˆ†ç±»å±•ç¤º',
                        left: 'center'
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            const data = params.data;
                            return `${params.name}<br/>
                                    é¢˜ç›®: ${data.problemId}<br/>
                                    å½±å“å­¦ç”Ÿæ•°: ${params.value}äºº<br/>
                                    å æ¯”: ${params.percent}%<br/>
                                    å¹³å‡æŒæ¡åº¦: ${data.avg_score}åˆ†<br/>
                                    ä¸¥é‡ç¨‹åº¦: ${data.severity}`;
                        }
                    },
                    legend: {
                        orient: 'vertical',
                        right: 'right',
                        top: 'middle',
                        type: 'scroll',
                        formatter: function(name) {
                            return name.length > 15 ? name.substring(0, 15) + '...' : name;
                        }
                    },
                    series: [{
                        name: 'è–„å¼±çŸ¥è¯†ç‚¹',
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['40%', '50%'],
                        avoidLabelOverlap: true,
                        itemStyle: {
                            borderRadius: 10,
                            borderColor: '#fff',
                            borderWidth: 2
                        },
                        label: {
                            show: true,
                            formatter: function(params) {
                                return params.data.problemId + '\n' + params.percent + '%';
                            }
                        },
                        emphasis: {
                            label: {
                                show: true,
                                fontSize: 14,
                                fontWeight: 'bold'
                            }
                        },
                        data: allCategories.map(cat => ({
                            name: cat.name,
                            value: cat.value,
                            problemId: cat.problemId,
                            avg_score: cat.avg_score,
                            severity: cat.severity
                        }))
                    }]
                };
                chart.setOption(option);
            }

            // æŒ‰é¢˜ç›®æ¸²æŸ“è¯¦ç»†åˆ—è¡¨
            const detailsHTML = Object.entries(weakPointsByProblem).map(([problemId, problemData]) => {
                const categories = problemData.classified_categories || [];
                
                if (categories.length === 0) {
                    return `
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-2">ğŸ“ ${problemId}</h3>
                            <p class="text-gray-500 italic">è¯¥é¢˜ç›®æ— è–„å¼±çŸ¥è¯†ç‚¹æˆ–AIå½’ç±»å¤±è´¥</p>
                        </div>
                    `;
                }

                return `
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h3 class="text-2xl font-bold text-gray-900 mb-4">ğŸ“ ${problemId}</h3>
                        
                        <div class="space-y-4">
                            ${categories.map(cat => {
                                const severityColor = {
                                    'é«˜': 'red',
                                    'ä¸­': 'yellow',
                                    'ä½': 'green'
                                }[cat.severity] || 'gray';

                                return `
                                    <div class="border-l-4 border-${severityColor}-500 bg-gray-50 rounded-lg p-4">
                                        <div class="flex justify-between items-start mb-3">
                                            <div class="flex-1">
                                                <h4 class="text-lg font-bold text-gray-900">${cat.name}</h4>
                                                <p class="text-sm text-gray-600 mt-1">${cat.description}</p>
                                            </div>
                                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-${severityColor}-100 text-${severityColor}-800 ml-4">
                                                ${cat.severity}
                                            </span>
                                        </div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="text-center bg-white rounded p-2">
                                                <p class="text-xl font-bold text-gray-900">${cat.student_count}</p>
                                                <p class="text-xs text-gray-600">å½±å“å­¦ç”Ÿæ•°</p>
                                            </div>
                                            <div class="text-center bg-white rounded p-2">
                                                <p class="text-xl font-bold text-gray-900">${cat.avg_score.toFixed(1)}</p>
                                                <p class="text-xs text-gray-600">å¹³å‡æŒæ¡åº¦</p>
                                            </div>
                                        </div>
                                        ${cat.students && cat.students.length > 0 ? `
                                            <details class="mt-3">
                                                <summary class="cursor-pointer text-blue-600 hover:text-blue-800 text-sm font-semibold">
                                                    ğŸ‘¥ æŸ¥çœ‹å…·ä½“å­¦ç”Ÿ (${cat.students.length}äºº)
                                                </summary>
                                                <div class="mt-2 bg-white rounded p-2">
                                                    <div class="flex flex-wrap gap-2">
                                                        ${cat.students.map(studentId => `
                                                            <span class="px-2 py-1 bg-blue-50 text-blue-700 rounded text-xs cursor-pointer hover:bg-blue-100"
                                                                  onclick="event.stopPropagation(); showStudentDetail('${studentId}')">
                                                                ${studentId}
                                                            </span>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </details>
                                        ` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('weakPointsDetails').innerHTML = detailsHTML;
        }

        // æ¸²æŸ“é¢˜ç›®ç»Ÿè®¡
        function renderProblems() {
            const problems = dashboardData.problems;
            const tbody = document.getElementById('problemsTableBody');
            const filter = document.getElementById('problemFilter');

            // å¡«å……ç­›é€‰å™¨
            filter.innerHTML = '<option value="">æ‰€æœ‰é¢˜ç›®</option>' +
                Object.keys(problems).map(id => `<option value="${id}">${id}</option>`).join('');

            // æ ¼å¼åŒ–æ—¶é—´
            function formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}h ${minutes}m`;
            }

            // æ¸²æŸ“è¡¨æ ¼
            tbody.innerHTML = Object.values(problems).map(p => `
                <tr class="hover:bg-gray-50 cursor-pointer problem-card" onclick="filterByProblem('${p.problem_id}')">
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${p.problem_id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">${p.total_students}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                            p.pass_rate >= 80 ? 'bg-green-100 text-green-800' :
                            p.pass_rate >= 60 ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${p.pass_rate.toFixed(1)}%
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">${p.average_score.toFixed(1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">${p.average_run_count.toFixed(1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">${p.average_test_count.toFixed(1)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-600">${formatTime(p.average_time_seconds)}</td>
                </tr>
            `).join('');
        }

        // æ¸²æŸ“å­¦ç”Ÿåˆ—è¡¨
        function renderStudents() {
            const students = dashboardData.students;
            const grid = document.getElementById('studentsGrid');

            // åº”ç”¨ç­›é€‰
            let filteredStudents = students.filter(s => {
                const matchesSearch = !currentStudentFilter || 
                    s.student_id.toLowerCase().includes(currentStudentFilter.toLowerCase());
                const matchesProblem = !currentProblemFilter || 
                    s.problems.some(p => p.problem_id === currentProblemFilter);
                return matchesSearch && matchesProblem;
            });

            grid.innerHTML = filteredStudents.map(student => {
                const problems = currentProblemFilter ? 
                    student.problems.filter(p => p.problem_id === currentProblemFilter) :
                    student.problems;

                const avgScore = problems.length > 0 ? 
                    (problems.reduce((sum, p) => sum + p.score, 0) / problems.length).toFixed(1) : 0;
                const passedCount = problems.filter(p => p.passed).length;
                
                // è®¡ç®—AIè¯„æµ‹å¹³å‡åˆ†
                const aiProblems = problems.filter(p => p.has_ai_analysis && p.ai_analysis);
                const avgAiScore = aiProblems.length > 0 ?
                    (aiProblems.reduce((sum, p) => sum + p.ai_analysis.mastery_percentage, 0) / aiProblems.length).toFixed(1) : null;

                return `
                    <div class="bg-white rounded-lg shadow p-6 student-card transition cursor-pointer"
                         onclick="showStudentDetail('${student.student_id}')">
                        <h3 class="text-lg font-bold text-gray-900 mb-4">ğŸ‘¤ ${student.student_id}</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span class="text-gray-600">å®Œæˆé¢˜ç›®:</span>
                                <span class="font-semibold">${problems.length}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">é€šè¿‡é¢˜ç›®:</span>
                                <span class="font-semibold text-green-600">${passedCount}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">å¹³å‡åˆ†:</span>
                                <span class="font-semibold">${avgScore}</span>
                            </div>
                            ${avgAiScore !== null ? `
                                <div class="flex justify-between border-t pt-2 mt-2">
                                    <span class="text-gray-600">ğŸ¤– AIè¯„æµ‹åˆ†æ•°:</span>
                                    <span class="font-semibold text-blue-600">${avgAiScore}</span>
                                </div>
                            ` : ''}
                        </div>
                        <button class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg transition">
                            æŸ¥çœ‹è¯¦æƒ…
                        </button>
                    </div>
                `;
            }).join('');
        }

        // æ˜¾ç¤ºå­¦ç”Ÿè¯¦æƒ…
        function showStudentDetail(studentId) {
            const student = dashboardData.students.find(s => s.student_id === studentId);
            if (!student) return;

            document.getElementById('modalTitle').textContent = `å­¦ç”Ÿè¯¦æƒ…: ${studentId}`;
            
            const content = `
                <div class="space-y-6">
                    ${student.problems.map(problem => {
                        const hasAI = problem.has_ai_analysis && problem.ai_analysis;
                        const ai = hasAI ? problem.ai_analysis : null;
                        
                        return `
                            <div class="border rounded-lg p-6 bg-gray-50">
                                <h4 class="text-xl font-bold text-gray-900 mb-4">ğŸ“ ${problem.problem_id}</h4>
                                
                                <!-- åŸºæœ¬ç»Ÿè®¡ -->
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                                    <div class="bg-white rounded p-3">
                                        <p class="text-xs text-gray-600">åˆ†æ•°</p>
                                        <p class="text-2xl font-bold ${problem.passed ? 'text-green-600' : 'text-red-600'}">
                                            ${problem.score}
                                        </p>
                                    </div>
                                    <div class="bg-white rounded p-3">
                                        <p class="text-xs text-gray-600">è¿è¡Œæ¬¡æ•°</p>
                                        <p class="text-2xl font-bold">${problem.run_count}</p>
                                    </div>
                                    <div class="bg-white rounded p-3">
                                        <p class="text-xs text-gray-600">æµ‹è¯•æ¬¡æ•°</p>
                                        <p class="text-2xl font-bold">${problem.test_count}</p>
                                    </div>
                                    <div class="bg-white rounded p-3">
                                        <p class="text-xs text-gray-600">ç¼–è¾‘æ¬¡æ•°</p>
                                        <p class="text-2xl font-bold">${problem.edit_count}</p>
                                    </div>
                                </div>

                                ${hasAI ? `
                                    <!-- AIåˆ†æè¯¦ç»†å†…å®¹ -->
                                    <div class="bg-white rounded-lg p-4 mt-4 space-y-4">
                                        <h5 class="text-lg font-bold text-gray-900 border-b pb-2">ğŸ¤– AIæ·±åº¦åˆ†æ</h5>
                                        
                                        <!-- æ€»ä½“è¯„ä¼° -->
                                        <div class="bg-blue-50 rounded-lg p-4">
                                            <h6 class="font-bold text-gray-900 mb-3">ğŸ“Š æ€»ä½“è¯„ä¼°</h6>
                                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                                                <div>
                                                    <p class="text-xs text-gray-600">æŒæ¡åº¦</p>
                                                    <p class="text-xl font-bold text-blue-600">${ai.mastery_percentage}%</p>
                                                    <p class="text-xs text-gray-500">${ai.mastery_level}</p>
                                                </div>
                                                <div>
                                                    <p class="text-xs text-gray-600">æ¨èç­‰çº§</p>
                                                    <p class="text-2xl font-bold">${ai.grade_recommendation || 'N/A'}</p>
                                                </div>
                                                <div>
                                                    <p class="text-xs text-gray-600">åˆ†æç½®ä¿¡åº¦</p>
                                                    <p class="text-sm font-semibold">${ai.confidence_level}</p>
                                                </div>
                                            </div>
                                            ${ai.key_strengths && ai.key_strengths.length > 0 ? `
                                                <div class="mb-2">
                                                    <p class="text-xs font-semibold text-green-700 mb-1">âœ… ä¼˜åŠ¿:</p>
                                                    <ul class="text-xs text-gray-700 space-y-1">
                                                        ${ai.key_strengths.map(s => `<li class="break-words whitespace-normal">â€¢ ${s}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            ${ai.key_weaknesses && ai.key_weaknesses.length > 0 ? `
                                                <div class="mb-2">
                                                    <p class="text-xs font-semibold text-red-700 mb-1">âš ï¸ åŠ£åŠ¿:</p>
                                                    <ul class="text-xs text-gray-700 space-y-1">
                                                        ${ai.key_weaknesses.map(w => `<li class="break-words whitespace-normal">â€¢ ${w}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            ${ai.priority_improvements && ai.priority_improvements.length > 0 ? `
                                                <div>
                                                    <p class="text-xs font-semibold text-blue-700 mb-1">ğŸ’¡ æ”¹è¿›å»ºè®®:</p>
                                                    <ul class="text-xs text-gray-700 space-y-1">
                                                        ${ai.priority_improvements.map(i => `<li class="break-words whitespace-normal">â€¢ ${i}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        <!-- ä»£ç è´¨é‡ & è°ƒè¯•èƒ½åŠ› -->
                                        <div class="grid md:grid-cols-2 gap-4">
                                            <div class="bg-green-50 rounded-lg p-3">
                                                <h6 class="font-bold text-gray-900 mb-2">ğŸ’» ä»£ç è´¨é‡</h6>
                                                <div class="space-y-1 text-xs">
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">æ­£ç¡®æ€§:</span>
                                                        <span class="font-semibold">${ai.code_correctness || 'N/A'}åˆ†</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">æ—¶é—´å¤æ‚åº¦:</span>
                                                        <span class="font-semibold ${ai.code_is_optimal ? 'text-green-600' : 'text-yellow-600'}">
                                                            ${ai.code_time_complexity || 'N/A'}
                                                        </span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">å¯è¯»æ€§:</span>
                                                        <span class="font-semibold">${ai.code_readability || 'N/A'}åˆ†</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">ä»£ç é£æ ¼:</span>
                                                        <span class="font-semibold">${ai.code_style || 'N/A'}åˆ†</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="bg-purple-50 rounded-lg p-3">
                                                <h6 class="font-bold text-gray-900 mb-2">ğŸ”§ è°ƒè¯•èƒ½åŠ›</h6>
                                                <div class="space-y-1 text-xs">
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">å¾—åˆ†:</span>
                                                        <span class="font-semibold text-purple-600">${ai.debugging_score}åˆ†</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">ç­‰çº§:</span>
                                                        <span class="font-semibold">${ai.debugging_level || 'N/A'}</span>
                                                    </div>
                                                    <div class="mt-2">
                                                        <p class="text-gray-600 mb-1">ç­–ç•¥:</p>
                                                        <p class="text-gray-700">${ai.debugging_strategy || 'N/A'}</p>
                                                    </div>
                                                    <div>
                                                        <p class="text-gray-600 mb-1">æ•ˆç‡:</p>
                                                        <p class="text-gray-700">${ai.error_fixing_efficiency || 'N/A'}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- å­¦ä¹ è¿‡ç¨‹ -->
                                        <div class="bg-yellow-50 rounded-lg p-3">
                                            <h6 class="font-bold text-gray-900 mb-2">ğŸ“š å­¦ä¹ è¿‡ç¨‹</h6>
                                            <div class="grid md:grid-cols-3 gap-3 text-xs">
                                                <div>
                                                    <p class="text-gray-600 mb-1">è§£é¢˜ç­–ç•¥:</p>
                                                    <p class="font-semibold">${ai.problem_solving_strategy || 'N/A'}</p>
                                                </div>
                                                <div>
                                                    <p class="text-gray-600 mb-1">ç‹¬ç«‹æ€§:</p>
                                                    <p class="font-semibold">${ai.independence_level || 'N/A'}</p>
                                                </div>
                                                <div>
                                                    <p class="text-gray-600 mb-1">æ—¶é—´ç®¡ç†:</p>
                                                    <p class="font-semibold">${ai.time_management || 'N/A'}</p>
                                                </div>
                                            </div>
                                            ${ai.total_iterations > 0 ? `
                                                <div class="mt-2 pt-2 border-t border-yellow-200">
                                                    <p class="text-gray-600 text-xs">è¿­ä»£æ¬¡æ•°: <span class="font-semibold">${ai.total_iterations}</span></p>
                                                    <p class="text-gray-600 text-xs">æ”¹è¿›æ¨¡å¼: <span class="font-semibold">${ai.improvement_pattern || 'N/A'}</span></p>
                                                    <p class="text-gray-700 text-xs mt-1">${ai.learning_curve || ''}</p>
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        <!-- çŸ¥è¯†ç‚¹è¯¦ç»†åˆ†æ -->
                                        ${ai.knowledge_points && ai.knowledge_points.length > 0 ? `
                                            <div class="bg-gray-50 rounded-lg p-3">
                                                <h6 class="font-bold text-gray-900 mb-2">ğŸ“– çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ</h6>
                                                <div class="space-y-2 max-h-96 overflow-y-auto">
                                                    ${ai.knowledge_points.map(kp => `
                                                        <div class="bg-white rounded p-3 border-l-4 ${kp.is_weak ? 'border-red-500' : 'border-green-500'}">
                                                            <div class="flex justify-between items-start mb-2">
                                                                <p class="text-xs font-semibold text-gray-900 break-words max-w-none">${kp.knowledge_point}</p>
                                                                <span class="text-xs px-2 py-1 rounded ${
                                                                    kp.mastery_score >= 80 ? 'bg-green-100 text-green-800' :
                                                                    kp.mastery_score >= 60 ? 'bg-yellow-100 text-yellow-800' :
                                                                    'bg-red-100 text-red-800'
                                                                }">${kp.mastery_score}åˆ†</span>
                                                            </div>
                                                            <p class="text-xs text-gray-600 break-words max-w-none">${kp.mastery_level}</p>
                                                            ${kp.specific_errors && kp.specific_errors.length > 0 ? `
                                                                <div class="mt-1">
                                                                    <p class="text-xs font-semibold text-red-600">âŒ å…·ä½“é”™è¯¯:</p>
                                                                    <ul class="text-xs text-gray-700 ml-3 list-disc">
                                                                        ${kp.specific_errors.map(error => `<li class="break-words whitespace-normal overflow-visible max-w-none">${error.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</li>`).join('')}
                                                                    </ul>
                                                                </div>
                                                            ` : ''}
                                                            ${kp.evidence_from_history && kp.evidence_from_history.length > 0 ? `
                                                                <div class="mt-1">
                                                                    <p class="text-xs font-semibold text-blue-600">ğŸ“‹ å†å²è¯æ®:</p>
                                                                    <ul class="text-xs text-gray-700 ml-3 list-disc">
                                                                        ${kp.evidence_from_history.map(evidence => `<li class="break-words whitespace-normal">${evidence.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</li>`).join('')}
                                                                    </ul>
                                                                </div>
                                                            ` : ''}
                                                            ${kp.improvement_suggestions && kp.improvement_suggestions.length > 0 ? `
                                                                <div class="mt-1">
                                                                    <p class="text-xs font-semibold text-green-600">ğŸ’¡ æ”¹è¿›å»ºè®®:</p>
                                                                    <ul class="text-xs text-gray-700 ml-3 list-disc">
                                                                        ${kp.improvement_suggestions.map(suggestion => `<li class="break-words whitespace-normal">${suggestion.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</li>`).join('')}
                                                                    </ul>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : '<p class="text-sm text-gray-500 italic mt-4">æš‚æ— AIåˆ†ææ•°æ®</p>'}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('studentModal').classList.remove('hidden');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('studentModal').classList.add('hidden');
        }

        // æŒ‰é¢˜ç›®ç­›é€‰
        function filterByProblem(problemId) {
            document.getElementById('problemFilter').value = problemId;
            currentProblemFilter = problemId;
            renderStudents();
            document.getElementById('studentsSection').scrollIntoView({ behavior: 'smooth' });
        }

        // æœç´¢å­¦ç”Ÿ
        document.getElementById('studentSearch').addEventListener('input', function(e) {
            currentStudentFilter = e.target.value;
            renderStudents();
        });

        // é¢˜ç›®ç­›é€‰
        document.getElementById('problemFilter').addEventListener('change', function(e) {
            currentProblemFilter = e.target.value;
            renderStudents();
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('studentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>

</body>
</html>


