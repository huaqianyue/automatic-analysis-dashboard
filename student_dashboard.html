<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿåˆ†ææŠ¥å‘Š</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .fullscreen {
            min-height: 100vh;
        }
    </style>
</head>
<body class="bg-gray-50 fullscreen">
    
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold text-gray-900">ğŸ“Š å­¦ç”Ÿåˆ†ææŠ¥å‘Š</h1>
                    <span id="studentIdDisplay" class="text-lg text-blue-600 font-medium"></span>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- é¢˜ç›®åˆ‡æ¢ä¸‹æ‹‰èœå• -->
                    <div class="relative" id="problemSelectorContainer">
                        <select id="problemSelector" class="hidden bg-white border border-gray-300 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <!-- é¢˜ç›®é€‰é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>
                    <a href="index.html" class="text-blue-600 hover:text-blue-800 font-medium">è¿”å›é¦–é¡µ</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 fullscreen">
        
        <!-- åŠ è½½æç¤º -->
        <div id="loadingScreen" class="text-center py-20">
            <div class="loading mx-auto mb-4"></div>
            <p class="text-gray-600">æ­£åœ¨åŠ è½½å­¦ç”Ÿæ•°æ®...</p>
        </div>

        <!-- é”™è¯¯æç¤º -->
        <div id="errorScreen" class="hidden text-center py-20">
            <div class="text-red-500 text-6xl mb-4">âš ï¸</div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">å­¦å·ä¸å­˜åœ¨</h2>
            <p class="text-gray-600 mb-4">è¯·è”ç³»ç®¡ç†å‘˜è·å–æ­£ç¡®çš„å­¦å·</p>
            <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition">è¿”å›é¦–é¡µ</a>
        </div>

        <!-- å­¦ç”Ÿè¯¦æƒ…å†…å®¹ -->
        <div id="studentContent" class="hidden">
            
            <!-- å­¦ç”ŸåŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
            <section class="mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-900">ğŸ‘¤ å­¦ç”ŸåŸºæœ¬ä¿¡æ¯</h2>
                        <div class="text-sm text-gray-500" id="studentInfo"></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="basicInfoCards">
                        <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </section>

            <!-- é¢˜ç›®è¯¦ç»†åˆ†æ -->
            <section class="mb-8" id="problemsAnalysis">
                <!-- é¢˜ç›®åˆ†æå†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
            </section>

        </div>

    </main>

    <script>
        // å…¨å±€æ•°æ®
        let dashboardData = null;
        let currentStudentId = null;
        let currentStudent = null;

        // ä»URLå‚æ•°è·å–å­¦å·
        function getStudentIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('studentId');
        }

        // åŠ è½½å­¦ç”Ÿæ•°æ®
        function loadStudentData() {
            currentStudentId = getStudentIdFromURL();
            
            if (!currentStudentId) {
                showError('æœªæä¾›å­¦å·å‚æ•°');
                return;
            }

            // æ˜¾ç¤ºå­¦å·
            document.getElementById('studentIdDisplay').textContent = `å­¦å·: ${currentStudentId}`;

            fetch('ç¬¬ä¸€æ¬¡ä½œä¸š_dashboard.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('æ•°æ®æ–‡ä»¶åŠ è½½å¤±è´¥');
                    }
                    return response.json();
                })
                .then(data => {
                    dashboardData = data;
                    
                    // æŸ¥æ‰¾å­¦ç”Ÿæ•°æ®
                    currentStudent = findStudentById(currentStudentId);
                    
                    if (currentStudent) {
                        renderStudentDashboard();
                    } else {
                        showError('å­¦å·ä¸å­˜åœ¨');
                    }
                })
                .catch(error => {
                    console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
                    showError('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                });
        }

        // æ ¹æ®å­¦å·æŸ¥æ‰¾å­¦ç”Ÿ
        function findStudentById(studentId) {
            if (!dashboardData || !dashboardData.students) return null;
            
            // æå–å­¦å·çš„æ•°å­—éƒ¨åˆ†è¿›è¡Œæ¯”è¾ƒï¼ˆJSONä¸­çš„æ ¼å¼ä¸º"å­¦å·_å§“å"ï¼‰
            return dashboardData.students.find(student => {
                const studentIdNumber = student.student_id.split('_')[0];
                return studentIdNumber === studentId;
            });
        }

        // æ¸²æŸ“å­¦ç”Ÿä»ªè¡¨æ¿
        function renderStudentDashboard() {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('studentContent').classList.remove('hidden');
            
            renderBasicInfo();
            renderProblemSelector();
        }

        // æ¸²æŸ“åŸºæœ¬ä¿¡æ¯
        function renderBasicInfo() {
            if (!currentStudent) return;
            
            // è®¡ç®—æ€»åˆ†ã€å®Œæˆé¢˜ç›®æ•°ã€å¹³å‡ç”¨æ—¶
            const totalScore = currentStudent.problems.reduce((sum, problem) => sum + problem.score, 0);
            const completedProblems = currentStudent.problems.filter(problem => problem.passed).length;
            const averageTime = currentStudent.problems.reduce((sum, problem) => sum + (problem.time_spent_seconds || 0), 0) / currentStudent.problems.length;
            
            document.getElementById('basicInfoCards').innerHTML = `
                <div class="bg-blue-50 rounded-lg p-4">
                    <div class="text-3xl font-bold text-blue-600">${totalScore}</div>
                    <div class="text-sm text-blue-800">æ€»åˆ†</div>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <div class="text-3xl font-bold text-green-600">${completedProblems}/${currentStudent.problems.length}</div>
                    <div class="text-sm text-green-800">å®Œæˆé¢˜ç›®æ•°</div>
                </div>
                <div class="bg-purple-50 rounded-lg p-4">
                    <div class="text-3xl font-bold text-purple-600">${averageTime.toFixed(1)}s</div>
                    <div class="text-sm text-purple-800">å¹³å‡ç”¨æ—¶</div>
                </div>
            `;
            
            document.getElementById('studentInfo').textContent = `å…± ${currentStudent.problems.length} é“é¢˜ç›®`;
        }

        // æ¸²æŸ“é¢˜ç›®é€‰æ‹©å™¨
        function renderProblemSelector() {
            if (!currentStudent || !currentStudent.problems) return;
            
            const selector = document.getElementById('problemSelector');
            const container = document.getElementById('problemSelectorContainer');
            
            // ç”Ÿæˆé¢˜ç›®é€‰é¡¹
            selector.innerHTML = currentStudent.problems.map((problem, index) => 
                `<option value="${index}">${problem.problem_id}</option>`
            ).join('');
            
            // æ˜¾ç¤ºé€‰æ‹©å™¨
            selector.classList.remove('hidden');
            
            // æ·»åŠ åˆ‡æ¢äº‹ä»¶
            selector.addEventListener('change', function() {
                renderProblemAnalysis(parseInt(this.value));
            });
            
            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªé¢˜ç›®
            if (currentStudent.problems.length > 0) {
                selector.value = '0';
                renderProblemAnalysis(0);
            }
        }

        // æ¸²æŸ“å•ä¸ªé¢˜ç›®åˆ†æ
        function renderProblemAnalysis(problemIndex) {
            if (!currentStudent || !currentStudent.problems || !currentStudent.problems[problemIndex]) return;
            
            const problem = currentStudent.problems[problemIndex];
            const hasAI = problem.has_ai_analysis && problem.ai_analysis;
            const ai = hasAI ? problem.ai_analysis : null;
            
            const problemHTML = `
                <div class="border rounded-lg p-6 bg-gray-50">
                    <h4 class="text-xl font-bold text-gray-900 mb-4">ğŸ“ ${problem.problem_id}</h4>
                    
                    <!-- åŸºæœ¬ç»Ÿè®¡ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="bg-white rounded p-3">
                            <p class="text-xs text-gray-600">åˆ†æ•°</p>
                            <p class="text-2xl font-bold ${problem.passed ? 'text-green-600' : 'text-red-600'}">
                                ${problem.score}
                            </p>
                        </div>
                        <div class="bg-white rounded p-3">
                            <p class="text-xs text-gray-600">è¿è¡Œæ¬¡æ•°</p>
                            <p class="text-2xl font-bold">${problem.run_count}</p>
                        </div>
                        <div class="bg-white rounded p-3">
                            <p class="text-xs text-gray-600">æµ‹è¯•æ¬¡æ•°</p>
                            <p class="text-2xl font-bold">${problem.test_count}</p>
                        </div>
                        <div class="bg-white rounded p-3">
                            <p class="text-xs text-gray-600">ç¼–è¾‘æ¬¡æ•°</p>
                            <p class="text-2xl font-bold">${problem.edit_count}</p>
                        </div>
                    </div>

                    ${hasAI ? `
                        <!-- AIåˆ†æè¯¦ç»†å†…å®¹ -->
                        <div class="bg-white rounded-lg p-4 mt-4 space-y-4">
                            <h5 class="text-lg font-bold text-gray-900 border-b pb-2">ğŸ¤– AIæ·±åº¦åˆ†æ</h5>
                            
                            <!-- æ€»ä½“è¯„ä¼° -->
                            <div class="bg-blue-50 rounded-lg p-4">
                                <h6 class="font-bold text-gray-900 mb-3">ğŸ“Š æ€»ä½“è¯„ä¼°</h6>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-3">
                                    <div>
                                        <p class="text-xs text-gray-600">æŒæ¡åº¦</p>
                                        <p class="text-xl font-bold text-blue-600">${ai.mastery_percentage}%</p>
                                        <p class="text-xs text-gray-500">${ai.mastery_level}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600">æ¨èç­‰çº§</p>
                                        <p class="text-2xl font-bold">${ai.grade_recommendation || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-xs text-gray-600">åˆ†æç½®ä¿¡åº¦</p>
                                        <p class="text-sm font-semibold">${ai.confidence_level}</p>
                                    </div>
                                </div>
                                ${ai.key_strengths && ai.key_strengths.length > 0 ? `
                                    <div class="mb-2">
                                        <p class="text-xs font-semibold text-green-700 mb-1">âœ… ä¼˜åŠ¿:</p>
                                        <ul class="text-xs text-gray-700 space-y-1">
                                            ${ai.key_strengths.map(s => `<li class="break-words whitespace-normal">â€¢ ${s}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${ai.key_weaknesses && ai.key_weaknesses.length > 0 ? `
                                    <div class="mb-2">
                                        <p class="text-xs font-semibold text-red-700 mb-1">âš ï¸ åŠ£åŠ¿:</p>
                                        <ul class="text-xs text-gray-700 space-y-1">
                                            ${ai.key_weaknesses.map(w => `<li class="break-words whitespace-normal">â€¢ ${w}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${ai.priority_improvements && ai.priority_improvements.length > 0 ? `
                                    <div>
                                        <p class="text-xs font-semibold text-blue-700 mb-1">ğŸ’¡ æ”¹è¿›å»ºè®®:</p>
                                        <ul class="text-xs text-gray-700 space-y-1">
                                            ${ai.priority_improvements.map(i => `<li class="break-words whitespace-normal">â€¢ ${i}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- ä»£ç è´¨é‡ & è°ƒè¯•èƒ½åŠ› -->
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="bg-green-50 rounded-lg p-3">
                                    <h6 class="font-bold text-gray-900 mb-2">ğŸ’» ä»£ç è´¨é‡</h6>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">æ­£ç¡®æ€§:</span>
                                            <span class="font-semibold">${ai.code_correctness || 'N/A'}åˆ†</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">æ—¶é—´å¤æ‚åº¦:</span>
                                            <span class="font-semibold ${ai.code_is_optimal ? 'text-green-600' : 'text-yellow-600'}">
                                                ${ai.code_time_complexity || 'N/A'}
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">å¯è¯»æ€§:</span>
                                            <span class="font-semibold">${ai.code_readability || 'N/A'}åˆ†</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">ä»£ç é£æ ¼:</span>
                                            <span class="font-semibold">${ai.code_style || 'N/A'}åˆ†</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-purple-50 rounded-lg p-3">
                                    <h6 class="font-bold text-gray-900 mb-2">ğŸ”§ è°ƒè¯•èƒ½åŠ›</h6>
                                    <div class="space-y-1 text-xs">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">å¾—åˆ†:</span>
                                            <span class="font-semibold text-purple-600">${ai.debugging_score}åˆ†</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">ç­‰çº§:</span>
                                            <span class="font-semibold">${ai.debugging_level || 'N/A'}</span>
                                        </div>
                                        <div class="mt-2">
                                            <p class="text-gray-600 mb-1">ç­–ç•¥:</p>
                                            <p class="text-gray-700">${ai.debugging_strategy || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="text-gray-600 mb-1">æ•ˆç‡:</p>
                                            <p class="text-gray-700">${ai.error_fixing_efficiency || 'N/A'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å­¦ä¹ è¿‡ç¨‹ -->
                            <div class="bg-yellow-50 rounded-lg p-3">
                                <h6 class="font-bold text-gray-900 mb-2">ğŸ“š å­¦ä¹ è¿‡ç¨‹</h6>
                                <div class="grid md:grid-cols-3 gap-3 text-xs">
                                    <div>
                                        <p class="text-gray-600 mb-1">è§£é¢˜ç­–ç•¥:</p>
                                        <p class="font-semibold">${ai.problem_solving_strategy || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600 mb-1">ç‹¬ç«‹æ€§:</p>
                                        <p class="font-semibold">${ai.independence_level || 'N/A'}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600 mb-1">æ—¶é—´ç®¡ç†:</p>
                                        <p class="font-semibold">${ai.time_management || 'N/A'}</p>
                                    </div>
                                </div>
                                ${ai.total_iterations > 0 ? `
                                    <div class="mt-2 pt-2 border-t border-yellow-200">
                                        <p class="text-gray-600 text-xs">è¿­ä»£æ¬¡æ•°: <span class="font-semibold">${ai.total_iterations}</span></p>
                                        <p class="text-gray-600 text-xs">æ”¹è¿›æ¨¡å¼: <span class="font-semibold">${ai.improvement_pattern || 'N/A'}</span></p>
                                        <p class="text-gray-700 text-xs mt-1">${ai.learning_curve || ''}</p>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <!-- çŸ¥è¯†ç‚¹è¯¦ç»†åˆ†æ -->
                            ${ai.knowledge_points && ai.knowledge_points.length > 0 ? `
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <h6 class="font-bold text-gray-900 mb-2">ğŸ“– çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ</h6>
                                    <div class="space-y-2 max-h-96 overflow-y-auto">
                                        ${ai.knowledge_points.map(kp => `
                                            <div class="bg-white rounded p-3 border-l-4 ${kp.is_weak ? 'border-red-500' : 'border-green-500'}">
                                                <div class="flex justify-between items-start mb-2">
                                                    <p class="text-xs font-semibold text-gray-900 break-words max-w-none">${kp.knowledge_point}</p>
                                                    <span class="text-xs px-2 py-1 rounded ${
                                                        kp.mastery_score >= 80 ? 'bg-green-100 text-green-800' :
                                                        kp.mastery_score >= 60 ? 'bg-yellow-100 text-yellow-800' :
                                                        'bg-red-100 text-red-800'
                                                    }">${kp.mastery_score}åˆ†</span>
                                                </div>
                                                <p class="text-xs text-gray-600 break-words max-w-none">${kp.mastery_level}</p>
                                                ${kp.specific_errors && kp.specific_errors.length > 0 ? `
                                                    <div class="mt-1">
                                                        <p class="text-xs font-semibold text-red-600">âŒ å…·ä½“é”™è¯¯:</p>
                                                        <ul class="text-xs text-gray-700 ml-3 list-disc">
                                                            ${kp.specific_errors.map(error => `<li class="break-words whitespace-normal overflow-visible max-w-none">${error.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</li>`).join('')}
                                                        </ul>
                                                    </div>
                                                ` : ''}
                                                ${kp.evidence_from_history && kp.evidence_from_history.length > 0 ? `
                                                    <div class="mt-1">
                                                        <p class="text-xs font-semibold text-green-600">âœ… å†å²è¯æ®:</p>
                                                        <ul class="text-xs text-gray-700 ml-3 list-disc">
                                                            ${kp.evidence_from_history.map(evidence => `<li class="break-words whitespace-normal overflow-visible max-w-none">${evidence.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</li>`).join('')}
                                                        </ul>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="bg-yellow-50 rounded-lg p-4 text-center">
                            <p class="text-yellow-800">âš ï¸ è¯¥é¢˜ç›®æš‚æ— AIåˆ†ææ•°æ®</p>
                        </div>
                    `}
                </div>
            `;
            
            document.getElementById('problemsAnalysis').innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">ğŸ“ é¢˜ç›®è¯¦ç»†åˆ†æ</h2>
                    ${problemHTML}
                </div>
            `;
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(message) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('errorScreen').classList.remove('hidden');
            document.getElementById('errorScreen').querySelector('h2').textContent = message;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadStudentData();
        });
    </script>
</body>
</html>